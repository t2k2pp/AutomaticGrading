# PM試験AI採点システム レビュー

## 致命的 / 高優先度
- 採点済み回答の再採点が行われない: `src/api/services/scoring_service.py:82`-`90` で既存の `ScoringResult` (status=`COMPLETED`) を無条件に返しています。`submit_answer` 側では回答本文を更新してもスコアが失効せず、利用者が修正回答を送っても旧スコアが返るため、業務上致命的です。回答の `updated_at` とスコアの `scoring_completed_at` を比較して再採点する、あるいは回答更新時に関連する結果を `PENDING` に戻すなどの失効処理が必要です。
- CSV一括アップロード処理で閉じたDBセッションを利用している: `src/api/routers/admin.py:334`-`339` でリクエスト依存の `db` セッションをそのまま `BackgroundTasks` に渡し、タスク本体 (`_process_questions_csv_upload` at `src/api/routers/admin.py:437`-`520`) で利用しています。FastAPIはレスポンス送信後に依存関係の `finally` を実行してセッションを `close()` するため、バックグラウンド処理開始時点でセッションが無効化され、`sqlalchemy.exc.ResourceClosedError` が発生します。タスク側で新しいセッションを生成するか、`SessionLocal` を渡してタスク内で `Session()` を開くようにしてください。
- 管理APIに認証・認可がなく外部から操作可能: `src/api/routers/admin.py` 全体で認証デコレータや認可チェックが存在せず、誰でも試験・問題を作成/更新/削除でき、`/questions/csv/execute` から任意のCSVを取り込ませられます。管理系エンドポイントには少なくともトークン認証とロールベースのアクセス制御を追加してください。

## 中優先度
- 文字数制限バリデーションが不足: `src/api/services/scoring_service.py:44`-`59` では `Question.max_chars` を参照せずに `answer_text` を保存しています。上限超過の回答を許すと採点モデルが前提とする制限と乖離するため、保存前に文字数チェックしてバリデーションエラーを返却する、もしくはサーバ側でトリミングする必要があります。
- タイムゾーン非対応の日時を保存: `datetime.utcnow()` を `DateTime(timezone=True)` カラム (`src/api/services/scoring_service.py:49`, `97`, `129` など) に設定しています。SQLAlchemyはタイムゾーン情報のない日時を警告し、UTC以外のDBでは不整合を招きます。`datetime.now(timezone.utc)` を使うか、`sqlalchemy.func.now()` に統一することを推奨します。

## セキュリティ関連の追加指摘
- 共通設定で `SECRET_KEY` がデフォルト固定値 (`src/api/config.py:20`) のままです。本番では環境変数必須にし、起動時に未設定ならエラーにする方が安全です。
- CORS許可リストがローカルホスト限定 (`src/api/main.py:39`-`45`) のため、ステージング/本番URLを導入する際は環境変数化して管理してください。
- AIエンジン呼び出しがHTTP平文 (`src/api/services/scoring_service.py:148`) になっています。社外ネットワーク経由で疎通する場合はTLS終端やAPIキーの付与を検討してください。

## テスト観点
- 回答更新後も古いスコアが返る問題を検知するユニット/統合テストが存在しません (`tests` 配下を検索しても `evaluate_answer` に言及なし)。回答を更新→再採点して新スコアが得られることを検証するテストを追加してください。
- バックグラウンドCSV処理やエラー時のロールバックについてのテストが未整備です。疑似CSVを投入し、成功・失敗時のDB状態とログ出力を検証するテストを追加してください。

## 推奨アクション
1. 回答更新時に既存スコアを無効化し再採点できるようサービス層を修正する。
2. バックグラウンドタスク用にセッションファクトリを渡し、タスク内で独立したセッション管理を行う。
3. 管理系APIへJWTやOAuth2などの認証/認可を導入し、監査ログも記録する。
4. 回答保存時のバリデーションとタイムゾーン取り扱いを見直す。
5. 上記修正を担保する自動テストを追加し、CIで回るようにする。
