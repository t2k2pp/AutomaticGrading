# PM試験AI採点システム 再レビュー

## 致命的 / 高優先度
- 回答の更新時刻が未設定のまま再採点判定を行うと `None <= datetime` 比較で `TypeError` が発生し、リクエストが500になります (`src/api/services/scoring_service.py:106`-`114`)。初回採点後に回答を編集していないケースでは `Answer.updated_at` が `NULL` のままなので、既存スコアの再利用も再採点もできなくなります。`updated_at` が `None` の場合は再採点不要として扱うか、初回登録時にUTCのタイムスタンプを付与してください。
- 文字数超過などで `ScoringService.submit_answer` が `ValueError` を送出すると、ルーター側で500として扱われてしまいクライアントが原因不明のサーバーエラーを受け取ります (`src/api/services/scoring_service.py:37`-`44`, `src/api/routers/scoring.py:133`-`138`)。業務ロジック違反は 4xx で返すようにハンドリングを追加してください。

## 中優先度
- `SECRET_KEY` と `ADMIN_API_KEY` に依然として既定値がハードコードされており、環境変数を設定し忘れても既知のキーで本番が起動してしまいます (`src/api/config.py:20`, `src/api/config.py:44`)。最低でも起動時に未設定をエラーにするか、少なくとも placeholder 文字列では動かないように変更してください。

## テスト観点
- 再採点ロジックや文字数制限の挙動をカバーするテストが追加されていないため、今回の不具合は自動テストで検知できません。回答更新→再採点、および上限制約違反時に400が返るケースをテスト化すると安全になります。

## 改善点
- バックグラウンド処理用に専用のDBセッションを確保し直した点と、日時をUTC付きで保存するようにした点は意図通り修正されていました。
